#ifndef _TEMP_MANAGEMENT_H_
#define _TEMP_MANAGEMENT_H_

#include "hardware_profile.h"
#include "types.h"
#include "pwm.h"

typedef enum{
    TMP75_BR = 0,   // bottom right (close to PIC32)
    TMP75_TM,       // top middle (close to DC-DC)
    TMP75_MD,       // middle (between FPGAs)
    TMP75_LM,       // left middle (close to SoC)
    FPGA_ENC,       // internal sensor of ENCODER fpga
    FPGA_IO,        // internal sensor of IO_MIXER fpga
    TEMP_LM63_1,    // sensor from LM63 #1
    TEMP_LM63_2,    // sensor from LM63 #2
    NB_SENSORS
}TEMP_SENSOR;

#if defined (FAN_25x25) || defined (FAN_30x30)
    #define PWM_FREQ_COEF    25      //  7.8kHz
    #define PWM_FAN_MAX     100
    #define PWM_FAN_MIN       3
    // the response of the fan is not linear
    static const u8 fan_lut[101] = {
        0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
        0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1B, 0x1B, 0x1B,
        0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1C, 0x1C, 0x1C, 0x1C,
        0x1C, 0x1C, 0x1C, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1E, 0x1E,
        0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F, 0x20, 0x20, 0x20, 0x21,
        0x21, 0x22, 0x22, 0x22, 0x23, 0x23, 0x24, 0x24, 0x25, 0x25,
        0x26, 0x26, 0x27, 0x28, 0x28, 0x29, 0x2A, 0x2B, 0x2B, 0x2C,
        0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x34, 0x36, 0x37,
        0x38, 0x3A, 0x3B, 0x3D, 0x3E, 0x40, 0x42, 0x43, 0x45, 0x47,
        0x49, 0x4B, 0x4E, 0x50, 0x53, 0x55, 0x58, 0x5B, 0x5D, 0x60,
        0x64
    };

#elif defined (FAN_40x40)
    #define PWM_FREQ_COEF    (u8) 10      //  pbclk / (PWM_FREQ_COEF * 100) = 5.3kHz
    #define PWM_FAN_MAX      (u8)100
    #define PWM_FAN_MIN      (u8) 25
    // the response of the fan is not linear
    static const u8 fan_lut[101] = {
        0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A,
        0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1A, 0x1B, 0x1B, 0x1B,
        0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1B, 0x1C, 0x1C, 0x1C, 0x1C,
        0x1C, 0x1C, 0x1C, 0x1D, 0x1D, 0x1D, 0x1D, 0x1D, 0x1E, 0x1E,
        0x1E, 0x1E, 0x1F, 0x1F, 0x1F, 0x1F, 0x20, 0x20, 0x20, 0x21,
        0x21, 0x22, 0x22, 0x22, 0x23, 0x23, 0x24, 0x24, 0x25, 0x25,
        0x26, 0x26, 0x27, 0x28, 0x28, 0x29, 0x2A, 0x2B, 0x2B, 0x2C,
        0x2D, 0x2E, 0x2F, 0x30, 0x31, 0x32, 0x33, 0x34, 0x36, 0x37,
        0x38, 0x3A, 0x3B, 0x3D, 0x3E, 0x40, 0x42, 0x43, 0x45, 0x47,
        0x49, 0x4B, 0x4E, 0x50, 0x53, 0x55, 0x58, 0x5B, 0x5D, 0x60,
        0x64
    };

#elif defined (FAN_80x80)
    #define PWM_FREQ_COEF    20      // 10.0kHz
    #define PWM_FAN_MAX     100
    #define PWM_FAN_MIN      50
    // the response of the fan is not linear
    static const u8 fan_lut[101] = {
        0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33,
        0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x33, 0x34, 0x34,
        0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x34, 0x35,
        0x35, 0x35, 0x35, 0x35, 0x35, 0x35, 0x36, 0x36, 0x36, 0x36,
        0x36, 0x36, 0x37, 0x37, 0x37, 0x37, 0x38, 0x38, 0x38, 0x38,
        0x39, 0x39, 0x39, 0x39, 0x3A, 0x3A, 0x3A, 0x3B, 0x3B, 0x3C,
        0x3C, 0x3C, 0x3D, 0x3D, 0x3E, 0x3E, 0x3F, 0x3F, 0x40, 0x40,
        0x41, 0x42, 0x42, 0x43, 0x44, 0x44, 0x45, 0x46, 0x47, 0x48,
        0x49, 0x49, 0x4A, 0x4B, 0x4C, 0x4E, 0x4F, 0x50, 0x51, 0x52,
        0x54, 0x55, 0x56, 0x58, 0x59, 0x5B, 0x5D, 0x5E, 0x60, 0x62,
        0x64
    };

#else
    #error FAN model is not defined!
#endif


#define PWM_FAN_OFF       0

#define temp2celsius(t) ((t)&0x800)?((s8)(t>>4)-256):(s8)(t>>4);

#define set_fan_speed(speed)    pwm_set_duty_cycle(PWM_1, speed*PWM_FREQ_COEF);

RESULT temperature_management(u16 temp[]);
void fan_spin_up();

#endif
